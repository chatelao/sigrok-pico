# .github/workflows/build-release.yml

name: Build and Release UF2

on:
  push:
    tags:
      - 'v*.*.*'
      - 'v*.*'
      - 'v*'
  workflow_dispatch:

jobs:
  build_and_release:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      # 1. Code auschecken
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      # 2. Build-Abhängigkeiten installieren
      - name: Install Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake gcc-arm-none-eabi libnewlib-arm-none-eabi libstdc++-arm-none-eabi-newlib

      # 3. Projekt kompilieren (MIT KORREKTUR)
      - name: Build project
        run: |
          # Pfad zum SDK-Submodul setzen (wird an cmake übergeben)
          export PICO_SDK_PATH=$(pwd)/pico-sdk
          
          # Führe Cmake aus
          # HINZUGEFÜGT: -DCMAKE_MODULE_PATH=$(pwd)
          # Dies stellt sicher, dass cmake die 'pico_sdk_import.cmake' aus dem Repo-Root findet
          # und nicht die aus dem pico-sdk Submodul.
          cmake -B build -S pico_sdk_sigrok -DPICO_SDK_PATH=$PICO_SDK_PATH -DCMAKE_MODULE_PATH=$(pwd)
          
          # Make ausführen
          make -C build -j$(nproc)

      # 4. Artefakt für das Release vorbereiten
      - name: Prepare Release Artifacts
        id: prep
        run: |
          UF2_FILE="build/pico_sdk_sigrok.uf2"
          ARTIFACT_NAME="sigrok-pico-${{ github.ref_name }}.uf2"
          cp $UF2_FILE $ARTIFACT_NAME
          echo "artifact_name=$ARTIFACT_NAME" >> $GITHUB_OUTPUT
          echo "tag_name=${{ github.ref_name }}" >> $GITHUB_OUTPUT

      # 5. GitHub Release erstellen und UF2 hochladen
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.prep.outputs.tag_name }}
          name: "Release ${{ steps.prep.outputs.tag_name }}"
          body: "Automatisierter Build von `pico_sdk_sigrok.uf2` für dieses Release."
          draft: false
          prerelease: false
          files: ${{ steps.prep.outputs.artifact_name }}
